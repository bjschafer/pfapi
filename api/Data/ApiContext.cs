using System.Text.Json;

using api.Models.Database;

using Microsoft.EntityFrameworkCore;

namespace api.Data;

public class ApiContext(DbContextOptions<ApiContext> options) : DbContext(options)
{
    public DbSet<Class>      Class      { get; set; } = null!;
    public DbSet<Spell>      Spell      { get; set; } = null!;
    public DbSet<Descriptor> Descriptor { get; set; } = null!;

#region Overrides of DbContext

    /// <inheritdoc />
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        modelBuilder.Entity<Spell>()
                    .OwnsMany(s => s.ClassLevels);
        modelBuilder.Entity<Class>()
                    .Property(c => c.SpellsPerDay)
                    .HasConversion(
                         s => JsonSerializer.Serialize(s, (JsonSerializerOptions?)null),
                         s => JsonSerializer.Deserialize<IDictionary<int, IDictionary<int, int>>>(s, (JsonSerializerOptions?)null)!);

        // ensure that certain fixed data (like class names) is always seeded into
        // the database. Note that even autogenerated IDs must be set on the objects therein
        var classSeedData = Helpers.GetSeedData<Class>("Class");
        modelBuilder.Entity<Class>()
                    .HasData(classSeedData);
        var descriptorseedData = Helpers.GetSeedData<Descriptor>("Descriptor");
        modelBuilder.Entity<Descriptor>()
                    .HasData(descriptorseedData);
    }

#endregion
}
